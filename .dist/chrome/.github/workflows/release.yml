# Release Workflow - Assistente de RegulaÃ§Ã£o MÃ©dica
# 
# Workflow automÃ¡tico para releases quando uma tag Ã© criada
# Executa build completo, cria GitHub release e opcionalmente faz upload para stores

name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      skip_stores:
        description: 'Skip store uploads'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

# ConfiguraÃ§Ãµes globais
env:
  NODE_VERSION: '18.x'
  CACHE_VERSION: 'v1'

# PermissÃµes necessÃ¡rias
permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  # === JOB 1: PREPARAÃ‡ÃƒO ===
  prepare:
    name: ğŸ”§ Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      should-upload-stores: ${{ steps.config.outputs.should-upload-stores }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”¢ Extract Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            IS_PRERELEASE="false"
            if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ·ï¸ Tag: $TAG"
          echo "ğŸ”„ Prerelease: $IS_PRERELEASE"
      
      - name: âš™ï¸ Configure Release
        id: config
        run: |
          SHOULD_UPLOAD_STORES="true"
          
          if [[ "${{ github.event.inputs.skip_stores }}" == "true" ]]; then
            SHOULD_UPLOAD_STORES="false"
          fi
          
          if [[ "${{ steps.version.outputs.is-prerelease }}" == "true" ]]; then
            SHOULD_UPLOAD_STORES="false"
          fi
          
          echo "should-upload-stores=$SHOULD_UPLOAD_STORES" >> $GITHUB_OUTPUT
          echo "ğŸª Upload to stores: $SHOULD_UPLOAD_STORES"

  # === JOB 2: VALIDAÃ‡ÃƒO PRÃ‰-RELEASE ===
  validate:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ”§ Run ESLint
        run: |
          npm run lint
          echo "âœ… ESLint passed"
      
      - name: ğŸ“„ Validate Manifests
        run: |
          npm run validate:manifests
          echo "âœ… Manifests validated"
      
      - name: ğŸ” Full Validation
        run: |
          npm run validate
          echo "âœ… Full validation completed"
      
      - name: ğŸ”’ Security Check
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security check passed"

  # === JOB 3: BUILD RELEASE ===
  build:
    name: ğŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    timeout-minutes: 15
    
    outputs:
      chrome-zip: ${{ steps.artifacts.outputs.chrome-zip }}
      firefox-zip: ${{ steps.artifacts.outputs.firefox-zip }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ¨ Build CSS
        run: |
          npm run build:css
          echo "âœ… CSS compiled"
      
      - name: ğŸ—ï¸ Build Extensions
        run: |
          npm run build
          echo "âœ… Extensions built for all targets"
      
      - name: ğŸ“¦ Create Distribution ZIPs
        run: |
          npm run build:zips
          echo "âœ… Distribution ZIPs created"
      
      - name: ğŸ“Š Collect Artifacts Info
        id: artifacts
        run: |
          CHROME_ZIP=$(ls dist-zips/*chrome*.zip | head -1)
          FIREFOX_ZIP=$(ls dist-zips/*firefox*.zip | head -1)
          
          echo "chrome-zip=$CHROME_ZIP" >> $GITHUB_OUTPUT
          echo "firefox-zip=$FIREFOX_ZIP" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Chrome ZIP: $CHROME_ZIP"
          echo "ğŸ“¦ Firefox ZIP: $FIREFOX_ZIP"
          
          # InformaÃ§Ãµes dos arquivos
          echo "### ğŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| Target | File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          for zip in dist-zips/*.zip; do
            if [[ -f "$zip" ]]; then
              SIZE=$(du -h "$zip" | cut -f1)
              BASENAME=$(basename "$zip")
              TARGET=$(echo "$BASENAME" | grep -o -E "(chrome|firefox)")
              echo "| $TARGET | $BASENAME | $SIZE |" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: ğŸ“¤ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: |
            dist-zips/*.zip
            .dist/
          retention-days: 30
          if-no-files-found: error

  # === JOB 4: CRIAR GITHUB RELEASE ===
  github-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, validate, build]
    timeout-minutes: 10
    
    outputs:
      release-url: ${{ steps.release.outputs.html_url }}
      release-id: ${{ steps.release.outputs.id }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: ./release-artifacts/
      
      - name: ğŸ“ Generate Changelog
        id: changelog
        run: |
          # Busca Ãºltima tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [[ -n "$LAST_TAG" ]]; then
            echo "ğŸ“‹ Generating changelog since $LAST_TAG"
            CHANGELOG=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD | grep -E "^- (feat|fix|docs|style|refactor|perf|test|chore|security)" | head -20)
          else
            echo "ğŸ“‹ First release - generating basic changelog"
            CHANGELOG="- Primeira release do Assistente de RegulaÃ§Ã£o MÃ©dica"
          fi
          
          if [[ -z "$CHANGELOG" ]]; then
            CHANGELOG="- AtualizaÃ§Ãµes diversas e melhorias"
          fi
          
          # Categoriza mudanÃ§as
          FEATURES=$(echo "$CHANGELOG" | grep "feat:" | sed 's/^- feat: /- /' || true)
          FIXES=$(echo "$CHANGELOG" | grep "fix:" | sed 's/^- fix: /- /' || true)
          OTHERS=$(echo "$CHANGELOG" | grep -v -E "(feat:|fix:)" || true)
          
          # Monta changelog formatado
          FORMATTED_CHANGELOG="## ğŸ‰ Release ${{ needs.prepare.outputs.version }}"
          
          if [[ -n "$FEATURES" ]]; then
            FORMATTED_CHANGELOG="$FORMATTED_CHANGELOG

### âœ¨ Novas Funcionalidades
$FEATURES"
          fi
          
          if [[ -n "$FIXES" ]]; then
            FORMATTED_CHANGELOG="$FORMATTED_CHANGELOG

### ğŸ› CorreÃ§Ãµes
$FIXES"
          fi
          
          if [[ -n "$OTHERS" ]]; then
            FORMATTED_CHANGELOG="$FORMATTED_CHANGELOG

### ğŸ”§ Outras AlteraÃ§Ãµes
$OTHERS"
          fi
          
          FORMATTED_CHANGELOG="$FORMATTED_CHANGELOG

### ğŸ“¦ Downloads
- **Chrome/Edge**: AssistenteDeRegulacao-chrome-v${{ needs.prepare.outputs.version }}.zip
- **Firefox**: AssistenteDeRegulacao-firefox-v${{ needs.prepare.outputs.version }}.zip

### ğŸ”§ InstalaÃ§Ã£o
1. Baixe o arquivo ZIP correspondente ao seu navegador
2. Extraia o arquivo em uma pasta local
3. Abra as extensÃµes do navegador
4. Ative o modo desenvolvedor
5. Clique em 'Carregar extensÃ£o sem compactaÃ§Ã£o'
6. Selecione a pasta extraÃ­da"
          
          # Salva changelog em arquivo
          echo "$FORMATTED_CHANGELOG" > changelog.md
          echo "changelog-file=changelog.md" >> $GITHUB_OUTPUT
      
      - name: ğŸš€ Create Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          release_name: "Release ${{ needs.prepare.outputs.version }}"
          body_path: changelog.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is-prerelease }}
      
      - name: ğŸ“¤ Upload Chrome ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./release-artifacts/dist-zips/${{ needs.build.outputs.chrome-zip }}
          asset_name: AssistenteDeRegulacao-chrome-v${{ needs.prepare.outputs.version }}.zip
          asset_content_type: application/zip
      
      - name: ğŸ“¤ Upload Firefox ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./release-artifacts/dist-zips/${{ needs.build.outputs.firefox-zip }}
          asset_name: AssistenteDeRegulacao-firefox-v${{ needs.prepare.outputs.version }}.zip
          asset_content_type: application/zip
      
      - name: ğŸ“‹ Release Summary
        run: |
          echo "### ğŸš€ GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: ${{ needs.prepare.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY

  # === JOB 5: UPLOAD PARA STORES (OPCIONAL) ===
  store-upload:
    name: ğŸª Upload to Stores
    runs-on: ubuntu-latest
    needs: [prepare, github-release]
    if: needs.prepare.outputs.should-upload-stores == 'true'
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        store: [chrome, firefox]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: ./release-artifacts/
      
      - name: ğŸ“ Prepare Artifacts
        run: |
          mkdir -p dist-zips
          cp ./release-artifacts/dist-zips/*.zip dist-zips/
          ls -la dist-zips/
      
      - name: ğŸ”µ Upload to Chrome Web Store
        if: matrix.store == 'chrome'
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        run: |
          if [[ -n "$CHROME_EXTENSION_ID" ]]; then
            echo "ğŸ”µ Uploading to Chrome Web Store..."
            npm run upload:chrome
            echo "âœ… Chrome Web Store upload completed"
          else
            echo "âš ï¸ Chrome Web Store credentials not configured"
          fi
      
      - name: ğŸ¦Š Upload to Firefox Add-ons
        if: matrix.store == 'firefox'
        env:
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}
        run: |
          if [[ -n "$FIREFOX_JWT_ISSUER" ]]; then
            echo "ğŸ¦Š Uploading to Firefox Add-ons..."
            npm run upload:firefox
            echo "âœ… Firefox Add-ons upload completed"
          else
            echo "âš ï¸ Firefox Add-ons credentials not configured"
          fi

  # === JOB 6: NOTIFICAÃ‡Ã•ES E CLEANUP ===
  notify:
    name: ğŸ“¢ Notifications & Cleanup
    runs-on: ubuntu-latest
    needs: [prepare, github-release, store-upload]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate Final Report
        run: |
          echo "# ğŸš€ Release Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: ${{ needs.prepare.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: ${{ needs.github-release.outputs.release-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation**: ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: ${{ needs.github-release.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Store Upload**: ${{ needs.store-upload.result == 'success' && 'âœ…' || needs.store-upload.result == 'skipped' && 'â­ï¸' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status geral
          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "## ğŸ‰ Release Status: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "Release ${{ needs.prepare.outputs.version }} has been successfully created!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ğŸ”— Check the release: ${{ needs.github-release.outputs.release-url }}" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ“¦ Test the downloaded ZIPs" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸª Monitor store approval status" >> $GITHUB_STEP_SUMMARY
            echo "4. ğŸ“¢ Announce the release to users" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Release Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Release process encountered errors. Please check the logs." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ¯ Set Final Status
        run: |
          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "âœ… Release workflow completed successfully"
            exit 0
          else
            echo "âŒ Release workflow failed"
            exit 1
          fi