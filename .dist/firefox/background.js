const api=globalThis.browser || globalThis.chrome;let fetchRegulationDetails,KeepAliveManager,getBrowserAPIInstance;let encryptForStorage,decryptFromStorage,cleanupExpiredData,MEDICAL_DATA_CONFIG;let createComponentLogger,logger;let keepAliveManager=null;const messageRateLimit=new Map();const RATE_LIMIT_WINDOW=60000;const MAX_MESSAGES_PER_WINDOW=100;async function loadModules(){try{console.log('[Background] Carregando módulos...');const apiModule=await import("./api.js");fetchRegulationDetails=apiModule.fetchRegulationDetails;const keepAliveModule=await import("./KeepAliveManager.js");KeepAliveManager=keepAliveModule.KeepAliveManager;const browserAPIModule=await import("./BrowserAPI.js");getBrowserAPIInstance=browserAPIModule.getBrowserAPIInstance;const cryptoModule=await import("./crypto-utils.js");encryptForStorage=cryptoModule.encryptForStorage;decryptFromStorage=cryptoModule.decryptFromStorage;cleanupExpiredData=cryptoModule.cleanupExpiredData;MEDICAL_DATA_CONFIG=cryptoModule.MEDICAL_DATA_CONFIG;const loggerModule=await import("./logger.js");createComponentLogger=loggerModule.createComponentLogger;logger=createComponentLogger('Background');console.log('[Background] Módulos carregados com sucesso');return true;}catch(error){console.error('[Background] Erro ao carregar módulos:',error);return false;}}function checkRateLimit(senderId){const now=Date.now();const key=senderId || 'unknown';if(!messageRateLimit.has(key)){messageRateLimit.set(key,{count: 1,windowStart: now});return true;}const rateData=messageRateLimit.get(key);if(now - rateData.windowStart > RATE_LIMIT_WINDOW){messageRateLimit.set(key,{count: 1,windowStart: now});return true;}if(rateData.count >=MAX_MESSAGES_PER_WINDOW){return false;}rateData.count++;return true;}function initializeKeepAlive(){if(!keepAliveManager && KeepAliveManager){try{keepAliveManager=new KeepAliveManager();if(logger){logger.info("KeepAliveManager inicializado",{operation: 'initializeKeepAlive'});}else{console.log('[Background] KeepAliveManager inicializado');}}catch(error){console.error('[Background] Erro ao inicializar KeepAliveManager:',error);}}}async function setupDataCleanup(){if(!cleanupExpiredData)return;try{await cleanupExpiredData(api);api.alarms.create('cleanupExpiredData',{periodInMinutes: 30});if(logger){logger.info('Sistema de limpeza automática configurado');}}catch(error){console.error('[Background] Erro ao configurar limpeza de dados:',error);}}api.alarms.onAlarm.addListener(async(alarm)=>{if(alarm.name==='cleanupExpiredData' && cleanupExpiredData){try{if(logger){logger.info('Executando limpeza automática de dados expirados',{operation: 'setupDataCleanup',alarmName: alarm.name});}await cleanupExpiredData(api);}catch(error){console.error('[Background] Erro na limpeza automática:',error);}}});api.runtime.onMessage.addListener(async(message,sender,sendResponse)=>{const timestamp=new Date().toISOString();const senderId=sender?.id || sender?.tab?.id || 'unknown';if(!checkRateLimit(senderId)){console.warn('[Background] Rate limit excedido para sender:',senderId);return false;}if(!sender || !sender.tab){if(!sender.id || sender.id !==api.runtime.id){console.warn('[Background] Mensagem rejeitada - origem não confiável');return false;}}else{const allowedOrigins=[ 'sigss.saude.gov.br','sigss-hom.saude.gov.br','sigss.mv.com.br','sigss.cloudmv.com.br','localhost:3000','localhost:8080','127.0.0.1' ];const senderUrl=sender.tab.url || sender.url || '';const senderOrigin=new URL(senderUrl).origin;const isAuthorized=allowedOrigins.some(domain=>{if(domain.startsWith('http')){return senderOrigin===domain;}return senderUrl.includes(domain);});if(!isAuthorized){console.warn('[Background] Mensagem rejeitada - origem não autorizada:',senderUrl);return false;}}if(!message || typeof message !=='object' || !message.type){console.warn('[Background] Mensagem rejeitada - estrutura inválida');return false;}const allowedMessageTypes=[ 'SAVE_REGULATION_DATA','GET_KEEPALIVE_STATUS','GET_PATIENT_DATA','VALIDATE_CNS','VALIDATE_CPF','CLEAR_CACHE' ];if(!allowedMessageTypes.includes(message.type)){console.warn('[Background] Tipo de mensagem não permitido:',message.type);return false;}console.log(`[Background] ${timestamp}- Mensagem autorizada:`,{type: message.type,senderId,origin: sender?.tab?.url || sender?.url || 'extension'});if(message.type==="SAVE_REGULATION_DATA"){if(!fetchRegulationDetails){console.error('[Background] fetchRegulationDetails não disponível');return false;}try{const regulationDetails=await fetchRegulationDetails(message.payload);if(regulationDetails){if(encryptForStorage && MEDICAL_DATA_CONFIG){const encryptedData=await encryptForStorage(regulationDetails,MEDICAL_DATA_CONFIG.SENSITIVE_TTL_MINUTES);await api.storage.local.set({pendingRegulation: encryptedData,pendingRegulationTimestamp: Date.now()});}else{await api.storage.local.set({pendingRegulation: regulationDetails,pendingRegulationTimestamp: Date.now()});}console.log('[Background] Detalhes da regulação salvos no storage local');}else{console.warn('[Background] Não foram encontrados detalhes para a regulação:',message.payload);}}catch(e){console.error('[Background] Falha ao buscar ou salvar dados da regulação:',e);}return true;}if(message.type==="GET_KEEPALIVE_STATUS"){if(keepAliveManager){try{const status=await keepAliveManager.getStatus();sendResponse(status);}catch(error){sendResponse({isActive: false,error: error.message});}}else{sendResponse({isActive: false,error: "KeepAliveManager não inicializado"});}return true;}console.warn('[Background] Tipo de mensagem não reconhecido:',message.type);return false;});async function openSidebar(tab){try{if(api.sidePanel){await api.sidePanel.open({windowId: tab.windowId});}else if(api.sidebarAction){await api.sidebarAction.toggle();}}catch(error){console.error('[Background] Erro ao abrir sidebar:',error);}}api.action.onClicked.addListener(openSidebar);api.runtime.onStartup.addListener(async()=>{console.log('[Background] Service worker reiniciado - reinicializando');await initializeExtension();});api.runtime.onInstalled.addListener(async(details)=>{console.log('[Background] Extensão instalada/atualizada');await initializeExtension();if(api.sidePanel){try{await api.sidePanel.setPanelBehavior({openPanelOnActionClick: false});}catch(e){console.error('[Background] Falha ao definir o comportamento do sidePanel:',e);}}try{api.contextMenus.create({id: "openSidePanel",title: "Alternar Assistente de Regulação",contexts: ["all"],});}catch(error){console.error('[Background] Erro ao criar menu de contexto:',error);}api.contextMenus.onClicked.addListener((info,tab)=>{if(info.menuItemId==="openSidePanel"){openSidebar(tab);}});if(details.reason==="install"){try{api.tabs.create({url: api.runtime.getURL("help.html")});}catch(error){console.error('[Background] Erro ao abrir página de ajuda:',error);}}});async function initializeExtension(){console.log('[Background] Iniciando extensão...');try{const modulesLoaded=await loadModules();if(modulesLoaded){initializeKeepAlive();await setupDataCleanup();if(logger){logger.info('[Background] Inicialização completa');}else{console.log('[Background] Inicialização completa');}}else{console.error('[Background] Falha ao carregar módulos - extensão pode não funcionar corretamente');}}catch(error){console.error('[Background] Erro na inicialização:',error);}}initializeExtension();