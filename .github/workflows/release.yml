# Release Workflow - Assistente de RegulaÃ§Ã£o MÃ©dica
# 
# Workflow automÃ¡tico para releases quando uma tag Ã© criada
# Executa build completo, cria GitHub release e opcionalmente faz upload para stores

name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: true
        type: string
      skip_stores:
        description: 'Skip store uploads'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean

# ConfiguraÃ§Ãµes globais
env:
  NODE_VERSION: '18.x'
  CACHE_VERSION: 'v1'

# PermissÃµes necessÃ¡rias
permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  # === JOB 1: PREPARAÃ‡ÃƒO ===
  prepare:
    name: ğŸ”§ Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
      should-upload-stores: ${{ steps.config.outputs.should-upload-stores }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”¢ Extract Version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
            $tag = "v$version"
            $isPrerelease = "${{ github.event.inputs.prerelease }}"
          } else {
            $tag = "${{ github.ref_name }}"
            $version = $tag.Substring(1)
            $isPrerelease = "false"
            if ($version -match "-[a-zA-Z]") {
              $isPrerelease = "true"
            }
          }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "is-prerelease=$isPrerelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ“¦ Version: $version"
          Write-Host "ğŸ·ï¸ Tag: $tag"
          Write-Host "ğŸ”„ Prerelease: $isPrerelease"

      - name: âš™ï¸ Configure Release
        id: config
        shell: pwsh
        run: |
          $shouldUploadStores = "true"
          if ("${{ github.event.inputs.skip_stores }}" -eq "true") {
            $shouldUploadStores = "false"
          }
          if ("${{ steps.version.outputs.is-prerelease }}" -eq "true") {
            $shouldUploadStores = "false"
          }
          "should-upload-stores=$shouldUploadStores" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸª Upload to stores: $shouldUploadStores"

  # === JOB 2: VALIDAÃ‡ÃƒO PRÃ‰-RELEASE ===
  validate:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ”§ Run ESLint
        run: |
          npm run lint
          echo "âœ… ESLint passed"
      
      - name: ğŸ“„ Validate Manifests
        run: |
          npm run validate:manifests
          echo "âœ… Manifests validated"
      
      - name: ğŸ” Full Validation
        run: |
          if npm run validate --silent 2>/dev/null; then
            echo "âœ… Full validation completed"
          else
            echo "âš ï¸ Full validation script not available, skipping"
          fi
      
      - name: ğŸ”’ Security Check
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security check passed"

  # === JOB 3: BUILD RELEASE ===
  build:
    name: ğŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    timeout-minutes: 15
    
    outputs:
      chrome-zip: ${{ steps.artifacts.outputs.chrome-zip }}
      firefox-zip: ${{ steps.artifacts.outputs.firefox-zip }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ¨ Build CSS
        run: |
          npm run build:css
          echo "âœ… CSS compiled"
      
      - name: ğŸ—ï¸ Build Extensions
        run: |
          npm run build
          echo "âœ… Extensions built for all targets"
      
      - name: ğŸ“¦ Create Distribution ZIPs
        run: |
          npm run build:zips
          echo "âœ… Distribution ZIPs created"
      
      - name: ğŸ“Š Collect Artifacts Info
        id: artifacts
        shell: pwsh
        run: |
          $chromeZip = (Get-ChildItem -Path dist-zips -Recurse -Filter "*chrome*.zip" | Select-Object -First 1)
          $firefoxZip = (Get-ChildItem -Path dist-zips -Recurse -Filter "*firefox*.zip" | Select-Object -First 1)
          "chrome-zip=$($chromeZip.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "firefox-zip=$($firefoxZip.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ“¦ Chrome ZIP: $($chromeZip.Name)"
          Write-Host "ğŸ“¦ Firefox ZIP: $($firefoxZip.Name)"
          "### ğŸ“¦ Build Artifacts" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          "| Target | File | Size |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          "|--------|------|------|" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          Get-ChildItem -Path dist-zips -Recurse -Filter "*.zip" | ForEach-Object {
            $size = "{0:N2} KB" -f ($_.Length / 1KB)
            $basename = $_.Name
            $target = if ($basename -match "chrome") { "chrome" } elseif ($basename -match "firefox") { "firefox" } else { "unknown" }
            "| $target | $basename | $size |" | Add-Content -Path $env:GITHUB_STEP_SUMMARY
          }
      
      - name: ğŸ“¤ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: |
            dist-zips/*.zip
            .dist/
          retention-days: 30
          if-no-files-found: error

  # === JOB 4: CRIAR GITHUB RELEASE ===
  github-release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, validate, build]
    timeout-minutes: 10
    
    outputs:
      release-url: ${{ steps.release.outputs.html_url }}
      release-id: ${{ steps.release.outputs.id }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: ./release-artifacts/

      - name: ğŸ“ Generate Changelog
        id: changelog
        shell: pwsh
        run: |
          $lastTag = git describe --tags --abbrev=0 HEAD^ 2>$null
          if ($LASTEXITCODE -ne 0) { $lastTag = "" }

          if ($lastTag) {
              Write-Host "ğŸ“‹ Generating changelog since $lastTag"
              $changelogLines = git log --pretty=format:"- %s" "$lastTag..HEAD" | Where-Object { $_ -match "^- (feat|fix|docs|style|refactor|perf|test|chore|security)" } | Select-Object -First 20
          } else {
              Write-Host "ğŸ“‹ First release - generating basic changelog"
              $changelogLines = @("- Primeira release do Assistente de RegulaÃ§Ã£o MÃ©dica")
          }

          if (-not $changelogLines) {
              $changelogLines = @("- AtualizaÃ§Ãµes diversas e melhorias")
          }

          $features = ($changelogLines | Where-Object { $_ -match "feat:" } | ForEach-Object { $_ -replace '^- feat: ', '- ' }) -join "`n"
          $fixes = ($changelogLines | Where-Object { $_ -match "fix:" } | ForEach-Object { $_ -replace '^- fix: ', '- ' }) -join "`n"
          $others = ($changelogLines | Where-Object { $_ -notmatch "(feat:|fix:)" }) -join "`n"

          $formattedChangelog = "## ğŸ‰ Release ${{ needs.prepare.outputs.version }}"
          if ($features) {
              $formattedChangelog += "`n`n### âœ¨ Novas Funcionalidades`n$features"
          }
          if ($fixes) {
              $formattedChangelog += "`n`n### ğŸ› CorreÃ§Ãµes`n$fixes"
          }
          if ($others) {
              $formattedChangelog += "`n`n### ğŸ”§ Outras AlteraÃ§Ãµes`n$others"
          }

          $formattedChangelog += @"
`n`n### ğŸ“¦ Downloads
- **Chrome/Edge**: AssistenteDeRegulacao-chrome-v${{ needs.prepare.outputs.version }}.zip
- **Firefox**: AssistenteDeRegulacao-firefox-v${{ needs.prepare.outputs.version }}.zip

### ğŸ”§ InstalaÃ§Ã£o
1. Baixe o arquivo ZIP correspondente ao seu navegador
2. Extraia o arquivo em uma pasta local
3. Abra as extensÃµes do navegador
4. Ative o modo desenvolvedor
5. Clique em 'Carregar extensÃ£o sem compactaÃ§Ã£o'
6. Selecione a pasta extraÃ­da
"@
          Set-Content -Path "changelog.md" -Value $formattedChangelog -Encoding utf8
          "changelog-file=changelog.md" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸ“¤ Rename Assets
        shell: pwsh
        run: |
          $chromeZip = (Get-ChildItem -Path ./release-artifacts/dist-zips -Recurse -Filter "*chrome*.zip" | Select-Object -First 1)
          $firefoxZip = (Get-ChildItem -Path ./release-artifacts/dist-zips -Recurse -Filter "*firefox*.zip" | Select-Object -First 1)
          if ($null -ne $chromeZip) {
            $newName = "AssistenteDeRegulacao-chrome-v${{ needs.prepare.outputs.version }}.zip"
            echo "âœ… Renaming Chrome ZIP to $newName"
            Rename-Item -Path $chromeZip.FullName -NewName $newName
          } else {
            echo "âš ï¸ Chrome ZIP not found"
          }
          if ($null -ne $firefoxZip) {
            $newName = "AssistenteDeRegulacao-firefox-v${{ needs.prepare.outputs.version }}.zip"
            echo "âœ… Renaming Firefox ZIP to $newName"
            Rename-Item -Path $firefoxZip.FullName -NewName $newName
          } else {
            echo "âš ï¸ Firefox ZIP not found"
          }
      
      - name: ğŸš€ Create Release
        id: release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "Release ${{ needs.prepare.outputs.version }}"
          body_path: changelog.md
          draft: false
          prerelease: ${{ needs.prepare.outputs.is-prerelease }}
          files: |
            ./release-artifacts/dist-zips/*.zip
          fail_on_unmatched_files: true

      - name: ğŸ“‹ Release Summary
        run: |
          echo "### ğŸš€ GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prerelease**: ${{ needs.prepare.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY

  # === JOB 5: UPLOAD PARA STORES (OPCIONAL) ===
  store-upload:
    name: ğŸª Upload to Stores
    runs-on: ubuntu-latest
    needs: [prepare, github-release]
    if: needs.prepare.outputs.should-upload-stores == 'true'
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        store: [chrome, firefox]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-builds-${{ needs.prepare.outputs.version }}
          path: ./release-artifacts/
      
      - name: ğŸ“ Prepare Artifacts
        run: |
          mkdir -p dist-zips
          cp ./release-artifacts/dist-zips/*.zip dist-zips/
          ls -la dist-zips/
      
      - name: ğŸ”µ Upload to Chrome Web Store
        if: matrix.store == 'chrome'
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
        shell: pwsh
        run: |
          if ($env:CHROME_EXTENSION_ID) {
            Write-Host "ğŸ”µ Uploading to Chrome Web Store..."
            npm run upload:chrome
            Write-Host "âœ… Chrome Web Store upload completed"
          } else {
            Write-Host "âš ï¸ Chrome Web Store credentials not configured"
          }
      
      - name: ğŸ¦Š Upload to Firefox Add-ons
        if: matrix.store == 'firefox'
        env:
          FIREFOX_JWT_ISSUER: ${{ secrets.FIREFOX_JWT_ISSUER }}
          FIREFOX_JWT_SECRET: ${{ secrets.FIREFOX_JWT_SECRET }}
        shell: pwsh
        run: |
          if ($env:FIREFOX_JWT_ISSUER) {
            Write-Host "ğŸ¦Š Uploading to Firefox Add-ons..."
            npm run upload:firefox
            Write-Host "âœ… Firefox Add-ons upload completed"
          } else {
            Write-Host "âš ï¸ Firefox Add-ons credentials not configured"
          }

  # === JOB 6: NOTIFICAÃ‡Ã•ES E CLEANUP ===
  notify:
    name: ğŸ“¢ Notifications & Cleanup
    runs-on: ubuntu-latest
    needs: [prepare, github-release, store-upload]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate Final Report
        shell: pwsh
        run: |
          $summary = @"
          # ğŸš€ Release Report

          ## ğŸ“‹ Release Information
          - **Version**: ${{ needs.prepare.outputs.version }}
          - **Tag**: ${{ needs.prepare.outputs.tag }}
          - **Prerelease**: ${{ needs.prepare.outputs.is-prerelease }}
          - **Release URL**: ${{ needs.github-release.outputs.release-url }}

          ## ğŸ¯ Job Results
          - **Validation**: $(if ('${{ needs.validate.result }}' -eq 'success') { 'âœ…' } else { 'âŒ' })
          - **Build**: $(if ('${{ needs.build.result }}' -eq 'success') { 'âœ…' } else { 'âŒ' })
          - **GitHub Release**: $(if ('${{ needs.github-release.result }}' -eq 'success') { 'âœ…' } else { 'âŒ' })
          - **Store Upload**: $(if ('${{ needs.store-upload.result }}' -eq 'success') { 'âœ…' } elseif ('${{ needs.store-upload.result }}' -eq 'skipped') { 'â­ï¸' } else { 'âŒ' })
          "@
          if ("${{ needs.github-release.result }}" -eq "success") {
            $summary += @"

            ## ğŸ‰ Release Status: âœ… SUCCESS
            Release ${{ needs.prepare.outputs.version }} has been successfully created!

            ### ğŸ“‹ Next Steps
            1. ğŸ”— Check the release: ${{ needs.github-release.outputs.release-url }}
            2. ğŸ“¦ Test the downloaded ZIPs
            3. ğŸª Monitor store approval status
            4. ğŸ“¢ Announce the release to users
"@
          } else {
            $summary += @"

            ## âŒ Release Status: FAILED
            Release process encountered errors. Please check the logs.
"@
          }
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
      
      - name: ğŸ¯ Set Final Status
        shell: pwsh
        run: |
          if ("${{ needs.github-release.result }}" -eq "success") {
            Write-Host "âœ… Release workflow completed successfully"
            exit 0
          } else {
            Write-Host "âŒ Release workflow failed"
            exit 1
          }
