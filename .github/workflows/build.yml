# Build Workflow - Assistente de RegulaÃ§Ã£o MÃ©dica
# 
# Workflow automÃ¡tico para build e validaÃ§Ã£o em PRs e pushes
# Executa matrix build para Chrome e Firefox em mÃºltiplos ambientes

name: ğŸ—ï¸ Build & Validation

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

# ConfiguraÃ§Ãµes globais
env:
  NODE_VERSION: '18.x'
  CACHE_VERSION: 'v1'

# PermissÃµes necessÃ¡rias
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # === JOB 1: VALIDAÃ‡ÃƒO INICIAL ===
  validate:
    name: ğŸ” Initial Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      should-build: ${{ steps.changes.outputs.should-build }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” Detect Changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            should-build:
              - 'src/**'
              - 'scripts/**'
              - '*.js'
              - '*.json'
              - 'package*.json'
              - 'webpack.config.js'
              - '.eslintrc.js'
      
      - name: ğŸ“‹ Get Version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"
      
      - name: âœ… Validation Complete
        run: |
          echo "ğŸ” Initial validation completed"
          echo "Should build: ${{ steps.changes.outputs.should-build }}"
          echo "Version: ${{ steps.version.outputs.version }}"

  # === JOB 2: LINT E VALIDAÃ‡Ã•ES ===
  lint:
    name: ğŸ”§ Lint & Code Quality
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-build == 'true'
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ”§ Run ESLint
        run: |
          npm run lint
          echo "âœ… ESLint passed"
      
      - name: ğŸ“„ Validate Manifests
        run: |
          npm run validate:manifests
          echo "âœ… Manifests validated"
      
      - name: ğŸ” Run Full Validation
        run: |
          npm run validate
          echo "âœ… Full validation completed"

  # === JOB 3: BUILD MATRIX ===
  build:
    name: ğŸ—ï¸ Build (${{ matrix.target }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [validate, lint]
    if: needs.validate.outputs.should-build == 'true'
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        target: [chrome, firefox]
        node-version: ['18.x', '20.x']
        exclude:
          # Reduz combinaÃ§Ãµes para economizar recursos
          - os: macos-latest
            node-version: '20.x'
          - os: windows-latest
            node-version: '20.x'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"
      
      - name: ğŸ¨ Build CSS
        run: |
          npm run build:css
          echo "âœ… CSS compiled"
      
      - name: ğŸ—ï¸ Build Extension (${{ matrix.target }})
        run: |
          npm run build:${{ matrix.target }}
          echo "âœ… Extension built for ${{ matrix.target }}"
      
      - name: ğŸ“¦ Create ZIP
        run: |
          npm run build:zips
          echo "âœ… ZIP created"
      
      - name: ğŸ“Š Build Report
        shell: bash
        run: |
          echo "### ğŸ—ï¸ Build Report (${{ matrix.target }}, ${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "dist-zips" ]; then
            echo "- **Artifacts**:" >> $GITHUB_STEP_SUMMARY
            find dist-zips -name "*.zip" -type f | while read -r file; do
              echo "  - $(basename "$file")" >> $GITHUB_STEP_SUMMARY
            done
          fi
      
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            dist-zips/*.zip
            .dist/${{ matrix.target }}/
          retention-days: 7
          if-no-files-found: error

  # === JOB 4: SECURITY SCAN ===
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-build == 'true'
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ”’ Run npm audit
        run: |
          npm audit --audit-level=moderate
          echo "âœ… npm audit passed"
      
      - name: ğŸ” Security Validation
        run: |
          if npm run validate --silent 2>/dev/null; then
            echo "âœ… Security validation completed"
          else
            echo "âš ï¸ Security validation script not available, skipping"
          fi
      
      - name: ğŸ“‹ Security Report
        run: |
          echo "### ğŸ”’ Security Report" >> $GITHUB_STEP_SUMMARY
          echo "- **npm audit**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Security validation**: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan date**: $(date)" >> $GITHUB_STEP_SUMMARY

  # === JOB 5: COMPATIBILITY TEST ===
  compatibility:
    name: ğŸŒ Cross-Browser Compatibility
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.validate.outputs.should-build == 'true'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ“¥ Download Chrome Build
        uses: actions/download-artifact@v4
        with:
          name: build-chrome-ubuntu-latest-node18.x
          path: ./artifacts/chrome/
      
      - name: ğŸ“¥ Download Firefox Build
        uses: actions/download-artifact@v4
        with:
          name: build-firefox-ubuntu-latest-node18.x
          path: ./artifacts/firefox/
      
      - name: ğŸ” Validate Chrome Build
        shell: pwsh
        run: |
          echo "ğŸ”µ Validating Chrome build..."
          $chromeZip = (Get-ChildItem -Path ./artifacts/chrome/dist-zips -Recurse -Filter "*chrome*.zip" | Select-Object -First 1)
          if ($null -ne $chromeZip) {
            echo "âœ… Chrome ZIP found: $($chromeZip.Name)"
            if ($chromeZip.Length -gt 0) {
              echo "âœ… ZIP file is not empty. Size: $($chromeZip.Length) bytes."
            } else {
              echo "âŒ ZIP file is empty."
              exit 1
            }
          } else {
            echo "âŒ Chrome ZIP not found"
            echo "Available files:"
            Get-ChildItem -Path ./artifacts/chrome -Recurse || echo "No files found"
            exit 1
          }
      
      - name: ğŸ” Validate Firefox Build
        shell: pwsh
        run: |
          echo "ğŸ¦Š Validating Firefox build..."
          $firefoxZip = (Get-ChildItem -Path ./artifacts/firefox/dist-zips -Recurse -Filter "*firefox*.zip" | Select-Object -First 1)
          if ($null -ne $firefoxZip) {
            echo "âœ… Firefox ZIP found: $($firefoxZip.Name)"
            if ($firefoxZip.Length -gt 0) {
              echo "âœ… ZIP file is not empty. Size: $($firefoxZip.Length) bytes."
            } else {
              echo "âŒ ZIP file is empty."
              exit 1
            }
          } else {
            echo "âŒ Firefox ZIP not found"
            echo "Available files:"
            Get-ChildItem -Path ./artifacts/firefox -Recurse || echo "No files found"
            exit 1
          }
      
      - name: ğŸ“‹ Compatibility Report
        run: |
          echo "### ğŸŒ Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Chrome Build**: âœ… Valid" >> $GITHUB_STEP_SUMMARY
          echo "- **Firefox Build**: âœ… Valid" >> $GITHUB_STEP_SUMMARY
          echo "- **Cross-platform**: âœ… Compatible" >> $GITHUB_STEP_SUMMARY

  # === JOB 6: FINAL REPORT ===
  report:
    name: ğŸ“Š Build Report
    runs-on: ubuntu-latest
    needs: [validate, lint, build, security, compatibility]
    if: always() && needs.validate.outputs.should-build == 'true'
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“Š Generate Final Report
        run: |
          echo "# ğŸ—ï¸ Build & Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation**: ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint**: ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compatibility**: ${{ needs.compatibility.result == 'success' && 'âœ…' || 'âŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status geral
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.security.result }}" == "success" && "${{ needs.compatibility.result }}" == "success" ]]; then
            echo "## ğŸ‰ Overall Status: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed! The build is ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Please review the logs and fix the issues." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ¯ Set Final Status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.build.result }}" == "success" && "${{ needs.security.result }}" == "success" && "${{ needs.compatibility.result }}" == "success" ]]; then
            echo "âœ… Build workflow completed successfully"
            exit 0
          else
            echo "âŒ Build workflow failed"
            exit 1
          fi