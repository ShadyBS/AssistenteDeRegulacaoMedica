# Continuous Integration Pipeline for Browser Extension
name: "CI - Browser Extension"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_call:
    outputs:
      build-status:
        description: "Build status"
        value: ${{ jobs.final-validation.outputs.status }}

env:
  NODE_VERSION: '18'
  CACHE_KEY: 'node-modules'

jobs:
  # ===============================
  # STAGE 1: VALIDATION & QUALITY
  # ===============================
  
  validate:
    name: ğŸ” Validation & Security
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Cache Dependencies
        id: cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-${{ env.CACHE_KEY }}-
            
      - name: ğŸ“¥ Install Dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci
        
      - name: ğŸ›¡ï¸ Security Audit
        run: npm audit --audit-level=moderate
        
      - name: ğŸ”’ Snyk Security Scan
        if: github.event_name == 'push'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ ! -z "$SNYK_TOKEN" ]; then
            npx snyk test --severity-threshold=high
          else
            echo "âš ï¸ Snyk token not found, skipping security scan"
          fi
        continue-on-error: true
        
      - name: âœ… Validate Manifests
        run: npm run validate:manifest
        
      - name: ğŸ” Validate Permissions
        run: npm run validate:permissions
        
      - name: ğŸ›¡ï¸ Validate CSP
        run: npm run validate:csp
        
      - name: ğŸ“Š Performance Validation
        run: npm run validate:performance

  lint:
    name: ğŸ¨ Code Quality & Linting
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¥ Install Dependencies
        if: needs.validate.outputs.cache-hit != 'true'
        run: npm ci
        
      - name: ğŸ” ESLint JavaScript
        run: npm run lint:js
        
      - name: ğŸ¨ StyleLint CSS
        run: npm run lint:css
        
      - name: ğŸ“„ HTMLHint HTML
        run: npm run lint:html

  # ===============================
  # STAGE 2: TESTING
  # ===============================
  
  test:
    name: ğŸ§ª Testing Suite
    runs-on: ubuntu-latest
    needs: [validate, lint]
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¥ Install Dependencies
        if: needs.validate.outputs.cache-hit != 'true'
        run: npm ci
        
      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests
        run: npm run test:${{ matrix.test-type }}
        
      - name: ğŸ“Š Upload Coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  cross-browser-test:
    name: ğŸŒ Cross-Browser Testing
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸŒ Install Browser (${{ matrix.browser }})
        if: matrix.browser == 'chrome'
        run: npx playwright install chromium
        
      - name: ğŸ¦Š Install Browser (${{ matrix.browser }})
        if: matrix.browser == 'firefox'
        run: npx playwright install firefox
        
      - name: ğŸŒ Install Browser (${{ matrix.browser }})
        if: matrix.browser == 'edge'
        run: npx playwright install chromium
        
      - name: ğŸ§ª Run Cross-Browser Tests
        run: BROWSER=${{ matrix.browser }} npm run test:cross-browser

  # ===============================
  # STAGE 3: BUILD & OPTIMIZATION
  # ===============================
  
  build:
    name: ğŸ—ï¸ Build Extension
    runs-on: ubuntu-latest
    needs: [test, cross-browser-test]
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ¨ Build CSS
        run: npm run build:css
        
      - name: ğŸ—ï¸ Build ${{ matrix.browser }} Extension
        run: npm run build:${{ matrix.browser }}
        
      - name: ğŸ“¦ Cache Build Artifacts
        uses: actions/cache@v3
        with:
          path: dist/${{ matrix.browser }}
          key: build-${{ matrix.browser }}-${{ github.sha }}
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.browser }}-${{ github.sha }}
          path: dist/${{ matrix.browser }}
          retention-days: 30

  # ===============================
  # STAGE 4: PACKAGING & VALIDATION
  # ===============================
  
  package:
    name: ğŸ“¦ Package Extensions
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-${{ env.CACHE_KEY }}-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ“¥ Install Dependencies
        run: npm ci
        
      - name: ğŸ“¦ Restore Build Artifacts
        uses: actions/cache@v3
        with:
          path: dist/${{ matrix.browser }}
          key: build-${{ matrix.browser }}-${{ github.sha }}
          
      - name: ğŸ“¦ Package ${{ matrix.browser }} Extension
        run: npm run package:${{ matrix.browser }}
        
      - name: âœ… Validate Package
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            npx web-ext lint --source-dir=dist/${{ matrix.browser }}
          fi
          
      - name: ğŸ“¤ Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.browser }}-${{ github.sha }}
          path: dist/packages/
          retention-days: 90

  # ===============================
  # STAGE 5: FINAL VALIDATION
  # ===============================
  
  final-validation:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: package
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download All Packages
        uses: actions/download-artifact@v4
        with:
          path: packages/
          
      - name: ğŸ” Validate All Packages
        run: |
          echo "ğŸ“¦ Validating all generated packages..."
          ls -la packages/
          
          # Validate package sizes
          for pkg in packages/package-*/; do
            size=$(du -sb "$pkg" | cut -f1)
            echo "Package $pkg size: $size bytes"
            
            # Check Chrome Web Store size limit (128MB)
            if [ $size -gt 134217728 ]; then
              echo "âŒ Package $pkg exceeds size limit"
              exit 1
            fi
          done
          
          echo "âœ… All packages validated successfully"
          
      - name: ğŸ“Š Generate Build Report
        run: |
          echo "# ğŸ“Š Build Report" > build-report.md
          echo "- **Commit:** ${{ github.sha }}" >> build-report.md
          echo "- **Branch:** ${{ github.ref_name }}" >> build-report.md
          echo "- **Timestamp:** $(date -u)" >> build-report.md
          echo "- **Node Version:** ${{ env.NODE_VERSION }}" >> build-report.md
          echo "" >> build-report.md
          echo "## ğŸ“¦ Generated Packages" >> build-report.md
          ls -la packages/ >> build-report.md
          
      - name: ğŸ“¤ Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ github.sha }}
          path: build-report.md

  # ===============================
  # NOTIFICATION
  # ===============================
  
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [validate, lint, test, cross-browser-test, build, package, final-validation]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify Success
        if: needs.final-validation.result == 'success'
        run: |
          echo "âœ… CI Pipeline completed successfully!"
          echo "ğŸ‰ All validations, tests, builds and packages are ready"
          
      - name: ğŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ CI Pipeline failed!"
          echo "ğŸ” Check the logs for details"
          exit 1
